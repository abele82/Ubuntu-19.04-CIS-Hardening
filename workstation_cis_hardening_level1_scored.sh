#! /bin/bash

# This script hardens the workstation in line with CIS Benchmark (for Level 1)
# It only includes CIS Workstation LEVEL 1 which are scored
# There are separate scripts to add the 'NOT scored' controls (workstation_cis_hardening_level1_NOT_scored.sh)

#########################################################################################################################################

#THIS SECTIONS CONFIRMS THAT THE SCRIPT HAS BEEN RUN WITH SUDO

if [[ $UID -ne 0 ]]; then
	echo "Need to run this script as root (with sudo)"
	exit 1
fi

echo "[I] Beginning hardening script now"

#########################################################################################################################################

#THIS SECTION 

# 1.1.1.1 Ensure mounting of cramfs filesystems is disabled (Scored)

echo "[I] Disabling the mounting of cramfs filesystems"
echo "install cramfs /bin/true" > /etc/modprobe.d/cramfs.conf
rmmod cramfs
sleep 1

#########################################################################################################################################

# 1.1.1.2 Ensure mounting of freevxfs filesystems is disabled (Scored)

echo "[I] Disabling the mounting of freevxfs filesystems"
echo "install freevxfs /bin/true" > /etc/modprobe.d/freevxfs.conf
rmmod freevxfs
sleep 1

#########################################################################################################################################

# 1.1.1.3 Ensure mounting of jffs2 filesystems is disabled (Scored)

echo "[I] Disabling the mounting of jffs2 filesystems"
echo "install jffs2 /bin/true" > /etc/modprobe.d/jffs2.conf
rmmod jffs2
sleep 1

#########################################################################################################################################

# 1.1.1.4 Ensure mounting of hfs filesystems is disabled (Scored)

echo "[I] Disabling the mounting of hfs filesystems"
echo "install hfs /bin/true" > /etc/modprobe.d/hfs.conf
rmmod hfs
sleep 1

#########################################################################################################################################

# 1.1.1.5 Ensure mounting of hfsplus filesystems is disabled (Scored)

echo "[I] Disabling the mounting of hfsplus filesystems"
echo "install hfsplus /bin/true" > /etc/modprobe.d/hfsplus.conf
rmmod hfsplus
sleep 1

#########################################################################################################################################


# 1.1.1.6 Ensure mounting of udf filesystems is disabled (Scored)

echo "[I] Disabling the mounting of udf filesystems"
echo "install udf /bin/true" > /etc/modprobe.d/udf.conf
rmmod udf
sleep 1

#########################################################################################################################################

# 1.1.3 Ensure nodev option set /tmp partition (Scored)
# 1.1.4 Ensure nosuid option set on /tmp partition (Scored)

LINETMP="tmpfs /tmp tmpfs nosuid,noexec,nodev,relatime,rw 0 0"

grep -F "$LINETMP" /etc/fstab || echo "$LINETMP" | sudo tee --append /etc/fstab > /dev/null

#########################################################################################################################################

# 1.1.7 Ensure nodev option set on /var/tmp partition (Scored)
# 1.1.8 Ensure nosuid option set on /var/tmp partition (Scored)
# 1.1.9 Ensure noexec option set on /var/tmp partition (Scored)

LINEVARTMP="tmpfs /var/tmp tmpfs nosuid,noexec,nodev 0 0"

grep -F "$LINEVARTMP" /etc/fstab || echo "$LINEVARTMP" | sudo tee --append /etc/fstab > /dev/null

#########################################################################################################################################

# 1.1.13 Ensure nodev option set on /home partition (Scored)

echo "[i] If you have a separate home partition, you need to provide it's name"
echo "[i] If a separate home partition doesn't exist, leave this blank."
echo "[i] Home partition example: /dev/xvda1"
read -p "[?] Enter home partition: " HOME_PARTITION

if [ -b $HOME_PARTITION ]
then

    LINEHOME="$HOME_PARTITION /home ext4 rw,relatime,nodev,data=ordered 0 0"

    grep -F "$LINEHOME" /etc/fstab || echo "$LINEHOME" | sudo tee --append /etc/fstab > /dev/null

fi

#########################################################################################################################################

# 1.1.14 Ensure nodev option set on /dev/shm partition (Scored)
# 1.1.15 Ensure nosuid option set on /dev/shm partition (Scored)
# 1.1.16 Ensure noexec option set on /dev/shm partition (Scored)

LINEDEVSHM="tmpfs /dev/shm tmpfs nosuid,noexec,nodev,relatime,rw 0 0"

grep -F "$LINEDEVSHM" /etc/fstab || echo "$LINEDEVSHM" | sudo tee --append /etc/fstab > /dev/null

#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################



#########################################################################################################################################
